<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpeakAcademy â€” Where in the World?</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #fff; overflow: hidden; height: 100vh; }

  #street-view { width: 100vw; height: 100vh; }

  /* â”€â”€ Top bar â”€â”€ */
  #top-bar {
    position: fixed; top: 0; left: 0; width: 100%; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 24px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
    pointer-events: none;
  }
  #logo { font-size: 1.2rem; font-weight: 700; letter-spacing: 0.05em; }
  #logo span { color: #facc15; }
  #round-badge {
    background: rgba(250,204,21,0.15); border: 1px solid #facc15;
    color: #facc15; padding: 6px 18px; border-radius: 999px;
    font-size: 0.95rem; font-weight: 700;
  }
  #phase-label {
    font-size: 0.95rem; opacity: 0.7; font-weight: 500; min-width: 160px; text-align: right;
  }
  #timer-badge {
    background: rgba(255,255,255,0.08); border: 1.5px solid rgba(255,255,255,0.2);
    color: #fff; padding: 6px 18px; border-radius: 999px;
    font-size: 1.1rem; font-weight: 800; letter-spacing: 0.05em;
    transition: background 0.3s, border-color 0.3s, color 0.3s;
    min-width: 72px; text-align: center;
  }
  #timer-badge.warning { background: rgba(250,204,21,0.15); border-color: #facc15; color: #facc15; }
  #timer-badge.danger  { background: rgba(239,68,68,0.2);   border-color: #ef4444; color: #ef4444; }

  /* â”€â”€ Score strip â”€â”€ */
  #scores {
    position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
    display: flex; flex-direction: column; gap: 10px; z-index: 10;
  }
  .score-card {
    background: rgba(0,0,0,0.65); border: 1.5px solid rgba(255,255,255,0.15);
    border-radius: 14px; padding: 12px 18px; text-align: center; min-width: 90px;
    transition: border-color 0.3s;
  }
  .score-card.winning { border-color: #facc15; }
  .score-name { font-size: 0.7rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.08em; }
  .score-val { font-size: 1.9rem; font-weight: 800; color: #facc15; line-height: 1.1; }
  .score-unit { font-size: 0.7rem; opacity: 0.5; margin-top: 1px; }

  /* â”€â”€ Bottom bar â”€â”€ */
  #bottom-bar {
    position: fixed; bottom: 0; left: 0; width: 100%; z-index: 10;
    padding: 18px 24px;
    background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, transparent 100%);
    display: flex; align-items: center; justify-content: center; gap: 14px;
  }
  .ctrl-btn {
    padding: 12px 28px; border-radius: 12px; border: none; cursor: pointer;
    font-size: 1rem; font-weight: 700; letter-spacing: 0.03em; transition: all 0.15s;
  }
  #btn-guess-a { background: #3b82f6; color: #fff; }
  #btn-guess-a:hover { background: #2563eb; }
  #btn-next { background: #facc15; color: #0f0f0f; display: none; }
  #btn-next:hover { background: #eab308; }
  #btn-skip-loc {
    background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);
    border: 1px solid rgba(255,255,255,0.2); display: none;
  }
  #btn-skip-loc:hover { background: rgba(255,255,255,0.2); color: #fff; }

  /* â”€â”€ Guess Map Overlay â”€â”€ */
  #guess-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 50;
    background: rgba(0,0,0,0.6);
    align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #guess-overlay.visible { display: flex; }
  #guess-map-wrap {
    position: relative;
    width: min(820px, 95vw); height: min(480px, 60vh);
    border-radius: 16px; overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.7);
    border: 2px solid rgba(255,255,255,0.2);
  }
  #guess-map { width: 100%; height: 100%; }
  #guess-header {
    font-size: 1.4rem; font-weight: 800; letter-spacing: 0.03em;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  }
  #guess-header.team-a { color: #60a5fa; }
  #guess-header.team-b { color: #f87171; }
  /* â”€â”€ Guess search â”€â”€ */
  #guess-search-wrap {
    display: none;   /* hidden by default â€” shown only inside .visible overlay */
    width: min(820px, 95vw);
    position: relative;
  }
  #guess-overlay.visible #guess-search-wrap { display: block; }
  #guess-search {
    width: 100%; padding: 10px 16px; border-radius: 10px;
    border: 1.5px solid rgba(255,255,255,0.25);
    background: #111; color: #fff;
    font-size: 0.95rem; outline: none;
    box-sizing: border-box;
    -webkit-appearance: none; appearance: none;
  }
  #guess-search::placeholder { color: rgba(255,255,255,0.35); }
  #guess-search:focus { border-color: #facc15; }
  #search-dropdown {
    display: none;
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: #1a1a1a; border: 1.5px solid rgba(255,255,255,0.2);
    border-radius: 10px; overflow: hidden; z-index: 200;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }
  #search-dropdown.visible { display: block; }
  .search-result {
    padding: 10px 16px; cursor: pointer; font-size: 0.9rem;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    transition: background 0.1s;
  }
  .search-result:last-child { border-bottom: none; }
  .search-result:hover, .search-result.active { background: rgba(250,204,21,0.15); color: #facc15; }
  .search-result-label { font-weight: 600; }
  .search-result-meta { font-size: 0.75rem; opacity: 0.5; margin-left: 6px; }

  #guess-footer {
    display: flex; gap: 12px; align-items: center;
  }
  #guess-hint { font-size: 0.85rem; opacity: 0.6; }
  #btn-confirm {
    display: none;
    background: #22c55e; color: #fff;
    padding: 10px 28px; border-radius: 10px; border: none;
    cursor: pointer; font-size: 1rem; font-weight: 700;
    transition: background 0.15s;
  }
  #btn-confirm:hover { background: #16a34a; }
  #btn-cancel-guess {
    background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6);
    padding: 10px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15);
    cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.15s;
  }
  #btn-cancel-guess:hover { background: rgba(255,255,255,0.15); color: #fff; }

  /* â”€â”€ Team Start Overlay â”€â”€ */
  #start-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 40;
    background: rgba(0,0,0,0.55);
    align-items: center; justify-content: center;
  }
  #start-overlay.visible { display: flex; }
  #start-box {
    display: flex; flex-direction: column; align-items: center; gap: 18px;
    text-align: center;
  }
  #start-team-label {
    font-size: 2.4rem; font-weight: 900; letter-spacing: 0.12em;
    text-shadow: 0 2px 16px rgba(0,0,0,0.8);
  }
  #start-team-label.team-a { color: #60a5fa; }
  #start-team-label.team-b { color: #f87171; }
  #start-sub {
    font-size: 1rem; opacity: 0.7;
    text-shadow: 0 1px 8px rgba(0,0,0,0.8);
  }
  #btn-start-turn {
    background: #facc15; color: #0f0f0f;
    font-size: 2rem; font-weight: 900; letter-spacing: 0.1em;
    padding: 22px 72px; border-radius: 18px; border: none;
    cursor: pointer; transition: all 0.15s;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  #btn-start-turn:hover { background: #fde047; transform: scale(1.04); }

  /* â”€â”€ Reveal Panel â”€â”€ */
  #reveal-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 60;
    background: rgba(0,0,0,0.55);
    align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #reveal-overlay.visible { display: flex; }
  #reveal-map-wrap {
    width: min(820px, 95vw); height: min(440px, 55vh);
    border-radius: 16px; overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.7);
    border: 2px solid rgba(250,204,21,0.4);
  }
  #reveal-map { width: 100%; height: 100%; }
  #reveal-scores {
    display: flex; gap: 20px; align-items: flex-start;
  }
  .reveal-team {
    background: rgba(0,0,0,0.75); border-radius: 14px; padding: 14px 22px;
    text-align: center; min-width: 150px; border: 2px solid rgba(255,255,255,0.1);
  }
  .reveal-team.winner { border-color: #facc15; }
  .reveal-team-name { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; }
  .reveal-round-km { font-size: 2rem; font-weight: 800; line-height: 1; }
  .reveal-round-km.team-a-color { color: #60a5fa; }
  .reveal-round-km.team-b-color { color: #f87171; }
  .reveal-total { font-size: 0.8rem; opacity: 0.55; margin-top: 4px; }
  .reveal-winner-badge { font-size: 0.75rem; color: #facc15; font-weight: 700; margin-top: 6px; }
  #reveal-location-label {
    font-size: 1.5rem; font-weight: 800; letter-spacing: 0.02em;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  }
  #btn-next-reveal {
    background: #facc15; color: #0f0f0f;
    padding: 12px 32px; border-radius: 12px; border: none;
    cursor: pointer; font-size: 1rem; font-weight: 800; transition: background 0.15s;
  }
  #btn-next-reveal:hover { background: #eab308; }

  /* â”€â”€ Game Over â”€â”€ */
  #gameover-overlay {
    display: none; position: fixed; inset: 0; z-index: 70;
    background: rgba(0,0,0,0.85);
    align-items: center; justify-content: center; flex-direction: column; gap: 20px;
  }
  #gameover-overlay.visible { display: flex; }
  #gameover-box {
    background: rgba(20,20,20,0.97); border: 1px solid rgba(250,204,21,0.4);
    border-radius: 24px; padding: 40px 56px; text-align: center;
    box-shadow: 0 24px 80px rgba(0,0,0,0.8);
  }
  #gameover-box h2 { font-size: 2rem; color: #facc15; margin-bottom: 8px; }
  #gameover-box h3 { font-size: 1.1rem; opacity: 0.6; margin-bottom: 28px; }
  #gameover-results { display: flex; gap: 24px; justify-content: center; margin-bottom: 28px; }
  .go-team { text-align: center; }
  .go-name { font-size: 0.8rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.1em; }
  .go-km { font-size: 3rem; font-weight: 900; line-height: 1; }
  .go-km.team-a-color { color: #60a5fa; }
  .go-km.team-b-color { color: #f87171; }
  .go-winner { font-size: 0.9rem; color: #facc15; font-weight: 700; margin-top: 4px; }
  #btn-restart {
    background: #facc15; color: #0f0f0f;
    padding: 12px 36px; border-radius: 12px; border: none;
    cursor: pointer; font-size: 1rem; font-weight: 800;
  }

  /* â”€â”€ Pack Selector â”€â”€ */
  #pack-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.88);
    align-items: center; justify-content: center;
  }
  #pack-overlay.visible { display: flex; }
  #pack-box {
    background: #1a1a1a; border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px; padding: 36px 40px;
    max-width: 640px; width: 90vw;
    text-align: center;
  }
  #pack-title {
    font-size: 1.8rem; font-weight: 800;
    margin-bottom: 6px;
  }
  #pack-subtitle {
    font-size: 0.95rem; opacity: 0.55;
    margin-bottom: 28px;
  }
  #pack-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .pack-btn {
    background: rgba(255,255,255,0.05);
    border: 1.5px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 14px 16px;
    cursor: pointer;
    color: #fff;
    display: flex; flex-direction: column; align-items: flex-start;
    gap: 4px;
    transition: all 0.15s;
    text-align: left;
  }
  .pack-btn:hover {
    background: rgba(250,204,21,0.12);
    border-color: #facc15;
  }
  .pack-name { font-size: 0.95rem; font-weight: 700; }
  .pack-count { font-size: 0.75rem; opacity: 0.5; }
  #pack-status { font-size: 0.85rem; opacity: 0.6; margin-top: 8px; min-height: 20px; }
</style>
</head>
<body>

<div id="street-view"></div>

<!-- Top bar -->
<div id="top-bar">
  <div id="logo">Speak<span>Academy</span></div>
  <div id="round-badge">Round <span id="round-num">1</span> / <span id="round-total">5</span></div>
  <div id="timer-badge">â± 1:30</div>
  <div id="phase-label">ğŸ“ Study the locationâ€¦</div>
</div>

<!-- Score strip -->
<div id="scores">
  <div class="score-card" id="score-card-0">
    <div class="score-name">Team A</div>
    <div class="score-val" id="score-0">0</div>
    <div class="score-unit">km total</div>
  </div>
  <div class="score-card" id="score-card-1">
    <div class="score-name">Team B</div>
    <div class="score-val" id="score-1">0</div>
    <div class="score-unit">km total</div>
  </div>
</div>

<!-- Team Start Overlay -->
<div id="start-overlay">
  <div id="start-box">
    <div id="start-team-label">TEAM A</div>
    <div id="start-sub">Study the location, then hit START when ready</div>
    <button id="btn-start-turn" onclick="beginTurn()">START</button>
  </div>
</div>

<!-- Bottom bar -->
<div id="bottom-bar">
  <button class="ctrl-btn" id="btn-skip-loc" onclick="skipLocation()">ğŸ”„ Load new place</button>
  <button class="ctrl-btn" id="btn-guess-a" onclick="openGuessMap(currentTeam)" style="display:none">ğŸ”µ Guess your location</button>
  <button class="ctrl-btn" id="btn-next" onclick="nextRound()">â­ Next Round</button>
</div>

<!-- Guess map overlay -->
<div id="guess-overlay">
  <div id="guess-header" class="team-a">ğŸ”µ TEAM A â€” Click your guess on the map</div>
  <div id="guess-search-wrap">
    <input id="guess-search" type="text" placeholder="ğŸ” Search for a city or placeâ€¦" autocomplete="off" />
    <div id="search-dropdown"></div>
  </div>
  <div id="guess-map-wrap">
    <div id="guess-map"></div>
  </div>
  <div id="guess-footer">
    <button id="btn-cancel-guess" onclick="cancelGuess()">âœ• Cancel</button>
    <div id="guess-hint">Click anywhere on the map to place your pin</div>
    <button id="btn-confirm" onclick="confirmGuess()">âœ” Confirm Guess</button>
  </div>
</div>

<!-- Reveal overlay -->
<div id="reveal-overlay">
  <div id="reveal-location-label">â€”</div>
  <div id="reveal-map-wrap">
    <div id="reveal-map"></div>
  </div>
  <div id="reveal-scores">
    <div class="reveal-team" id="reveal-card-0">
      <div class="reveal-team-name">Team A</div>
      <div class="reveal-round-km team-a-color" id="reveal-km-0">â€”</div>
      <div class="reveal-total" id="reveal-total-0"></div>
      <div class="reveal-winner-badge" id="reveal-badge-0"></div>
    </div>
    <div class="reveal-team" id="reveal-card-1">
      <div class="reveal-team-name">Team B</div>
      <div class="reveal-round-km team-b-color" id="reveal-km-1">â€”</div>
      <div class="reveal-total" id="reveal-total-1"></div>
      <div class="reveal-winner-badge" id="reveal-badge-1"></div>
    </div>
  </div>
  <button id="btn-next-reveal" onclick="nextRound()">Next Round â­</button>
</div>

<!-- Game Over overlay -->
<div id="gameover-overlay">
  <div id="gameover-box">
    <h2>ğŸ Game Over!</h2>
    <h3>Lowest total distance wins</h3>
    <div id="gameover-results">
      <div class="go-team">
        <div class="go-name">Team A</div>
        <div class="go-km team-a-color" id="go-km-0">0</div>
        <div>km</div>
        <div class="go-winner" id="go-winner-0"></div>
      </div>
      <div class="go-team">
        <div class="go-name">Team B</div>
        <div class="go-km team-b-color" id="go-km-1">0</div>
        <div>km</div>
        <div class="go-winner" id="go-winner-1"></div>
      </div>
    </div>
    <button id="btn-restart" onclick="restartGame()">ğŸ”„ Play Again</button>
  </div>
</div>

<!-- Pack Selector Overlay -->
<div id="pack-overlay">
  <div id="pack-box">
    <div id="pack-title">ğŸŒ Choose a Location Pack</div>
    <div id="pack-subtitle">Select a region or play all 1,523 locations</div>
    <div id="pack-grid"></div>
    <div id="pack-status"></div>
  </div>
</div>

<script src="config.js"></script>
<script>
// â”€â”€ API KEY (loaded from config.js â€” see config.example.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAPS_API_KEY is declared in config.js (gitignored)

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_ROUNDS = 5;

// â”€â”€ Location Database (loaded from JSON) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let LOCATIONS = [];
let currentPackLabel = 'All Locations';

const PACKS = [
  { id: 'all',           label: 'ğŸŒ All Locations',       file: 'data/locations.json',           count: 1523 },
  { id: 'europe',        label: 'ğŸŒ Europe',               file: 'data/packs/europe.json',         count: 461  },
  { id: 'asia',          label: 'ğŸŒ Asia & Middle East',   file: 'data/packs/asia.json',           count: 343  },
  { id: 'africa',        label: 'ğŸŒ Africa',               file: 'data/packs/africa.json',         count: 250  },
  { id: 'latin-america', label: 'ğŸŒ Latin America',        file: 'data/packs/latin-america.json',  count: 174  },
  { id: 'north-america', label: 'ğŸŒ North America',        file: 'data/packs/north-america.json',  count: 190  },
  { id: 'oceania',       label: 'ğŸŒ Oceania & Pacific',    file: 'data/packs/oceania.json',        count: 85   },
  { id: 'unusual',       label: 'ğŸ—ºï¸ Unusual Places',       file: 'data/packs/unusual.json',        count: 20   },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let panorama      = null;
let guessMap      = null;
let revealMap     = null;
let round         = 1;
let scores        = [0, 0];          // cumulative km, lower is better
let teamLocs      = [null, null];    // separate location per team each round
let guesses       = [null, null];    // {lat, lng, km} per team
let pendingMarker = null;
let pendingLatLng = null;
let guessMarkers  = [null, null];
let usedIndices   = [];
let currentTeam   = 0;              // 0 = Team A, 1 = Team B

// â”€â”€ Haversine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLng/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

// â”€â”€ Pick location â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pickLocation() {
  if (usedIndices.length >= LOCATIONS.length) usedIndices = [];
  let idx;
  do { idx = Math.floor(Math.random() * LOCATIONS.length); }
  while (usedIndices.includes(idx));
  usedIndices.push(idx);
  return LOCATIONS[idx];
}

// â”€â”€ Load Street View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPanorama(loc) {
  panorama.setPosition({ lat: loc.lat, lng: loc.lng });
  panorama.setPov({ heading: Math.floor(Math.random() * 360), pitch: 0, zoom: 1 });

  // Auto-skip if no coverage (black screen)
  google.maps.event.addListenerOnce(panorama, 'status_changed', function() {
    if (panorama.getStatus() !== 'OK') {
      console.warn('No coverage at', loc.label, 'â€” auto-skipping');
      document.getElementById('phase-label').textContent = 'âš ï¸ No coverage â€” loading anotherâ€¦';
      skipLocation();
    }
  });
}

// â”€â”€ Location Search (local database) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initLocationSearch() {
  const input    = document.getElementById('guess-search');
  const dropdown = document.getElementById('search-dropdown');
  let activeIdx  = -1;

  function showResults(query) {
    dropdown.innerHTML = '';
    activeIdx = -1;
    if (query.length < 2) { dropdown.classList.remove('visible'); return; }

    const q = query.toLowerCase();
    const matches = LOCATIONS
      .filter(loc => loc.label.toLowerCase().includes(q))
      .slice(0, 8);

    if (!matches.length) { dropdown.classList.remove('visible'); return; }

    matches.forEach((loc, i) => {
      const div = document.createElement('div');
      div.className = 'search-result';
      // Bold the matching part
      const idx = loc.label.toLowerCase().indexOf(q);
      const before = loc.label.slice(0, idx);
      const match  = loc.label.slice(idx, idx + q.length);
      const after  = loc.label.slice(idx + q.length);
      div.innerHTML = `<span class="search-result-label">${before}<strong>${match}</strong>${after}</span>`;
      div.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectResult(loc);
      });
      dropdown.appendChild(div);
    });
    dropdown.classList.add('visible');
  }

  function selectResult(loc) {
    input.value = '';
    dropdown.classList.remove('visible');
    const latLng = new google.maps.LatLng(loc.lat, loc.lng);
    guessMap.setCenter(latLng);
    guessMap.setZoom(6);
    handleMapClick(latLng);
  }

  input.addEventListener('input', () => showResults(input.value));
  input.addEventListener('blur',  () => setTimeout(() => dropdown.classList.remove('visible'), 150));
  input.addEventListener('keydown', (e) => {
    const items = dropdown.querySelectorAll('.search-result');
    if (e.key === 'ArrowDown') {
      activeIdx = Math.min(activeIdx + 1, items.length - 1);
    } else if (e.key === 'ArrowUp') {
      activeIdx = Math.max(activeIdx - 1, 0);
    } else if (e.key === 'Enter' && activeIdx >= 0) {
      e.preventDefault();
      items[activeIdx].dispatchEvent(new MouseEvent('mousedown'));
      return;
    } else if (e.key === 'Escape') {
      dropdown.classList.remove('visible');
      return;
    }
    items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
  });
}

// â”€â”€ Skip Location (manual button + auto-skip) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skipLocation() {
  const newLoc = pickLocation();
  teamLocs[currentTeam] = newLoc;
  loadPanorama(newLoc);
  document.getElementById('phase-label').textContent = 'ğŸ“ Study the locationâ€¦';
  // Only reset timer if the turn is already running (not during pre-turn load)
  if (timerInterval !== null) startGuessTimer(currentTeam);
}

function loadRound() {
  // Pick a DIFFERENT location for each team
  teamLocs[0]  = pickLocation();
  teamLocs[1]  = pickLocation();
  guesses      = [null, null];
  currentTeam  = 0;

  loadPanorama(teamLocs[0]);

  document.getElementById('round-num').textContent  = round;
  document.getElementById('phase-label').textContent = 'ğŸ“ Study the locationâ€¦';
  document.getElementById('btn-next').style.display  = 'none';

  updateScoreCards();
  showTeamStart(0);
}

// â”€â”€ Cancel Guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cancelGuess() {
  document.getElementById('guess-overlay').classList.remove('visible');
  document.getElementById('guess-search').value = '';
  if (pendingMarker) { pendingMarker.setMap(null); pendingMarker = null; }
  pendingLatLng = null;
  // Restore buttons (timer keeps running)
  const btn = document.getElementById('btn-guess-a');
  btn.textContent      = currentTeam === 0 ? 'ğŸ”µ Guess your location' : 'ğŸ”´ Guess your location';
  btn.style.background = currentTeam === 0 ? '#3b82f6' : '#ef4444';
  btn.style.color      = '#fff';
  btn.style.display    = 'inline-block';
  document.getElementById('btn-skip-loc').style.display = 'inline-block';
}

// â”€â”€ Open Guess Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGuessMap(team) {
  document.getElementById('btn-guess-a').style.display  = 'none';
  document.getElementById('btn-skip-loc').style.display = 'none';
  currentTeam  = team;
  pendingMarker = null;
  pendingLatLng = null;

  const header = document.getElementById('guess-header');
  const overlay = document.getElementById('guess-overlay');
  document.getElementById('btn-confirm').style.display = 'none';
  document.getElementById('guess-hint').textContent = 'Click anywhere on the map to place your pin';

  if (team === 0) {
    header.textContent  = 'ğŸ”µ TEAM A â€” Click your guess on the map';
    header.className    = 'team-a';
  } else {
    header.textContent  = 'ğŸ”´ TEAM B â€” Click your guess on the map';
    header.className    = 'team-b';
  }

  overlay.classList.add('visible');

  // Init guess map once
  if (!guessMap) {
    guessMap = new google.maps.Map(document.getElementById('guess-map'), {
      zoom: 2,
      center: { lat: 20, lng: 0 },
      mapTypeId: 'roadmap',
      disableDefaultUI: true,
      zoomControl: true,
      streetViewControl: false,
      styles: [{ featureType: 'all', stylers: [{ saturation: -30 }] }]
    });

    guessMap.addListener('click', function(e) {
      handleMapClick(e.latLng);
    });

    // Local search box â€” searches our LOCATIONS database
    initLocationSearch();
  }

  // Show Team A marker if it exists (during Team B's turn)
  if (team === 1 && guessMarkers[0]) {
    guessMarkers[0].setMap(guessMap);
  }
}

// â”€â”€ Handle map click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMapClick(latLng) {
  // Remove old pending marker
  if (pendingMarker) pendingMarker.setMap(null);

  const color = currentTeam === 0 ? '#3b82f6' : '#ef4444';
  const label = currentTeam === 0 ? 'A' : 'B';

  pendingMarker = new google.maps.Marker({
    position: latLng,
    map: guessMap,
    label: { text: label, color: '#fff', fontWeight: 'bold' },
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 14,
      fillColor: color,
      fillOpacity: 1,
      strokeColor: '#fff',
      strokeWeight: 2,
    }
  });

  pendingLatLng = latLng;
  document.getElementById('btn-confirm').style.display = 'inline-block';
  document.getElementById('guess-hint').textContent = 'Happy with your pin? Click Confirm.';
}

// â”€â”€ Confirm guess â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmGuess() {
  if (!pendingLatLng) return;
  pauseTimer();

  const loc = teamLocs[currentTeam];
  const km = haversine(
    pendingLatLng.lat(), pendingLatLng.lng(),
    loc.lat, loc.lng
  );

  guesses[currentTeam] = { lat: pendingLatLng.lat(), lng: pendingLatLng.lng(), km };
  guessMarkers[currentTeam] = pendingMarker;
  pendingMarker = null;

  document.getElementById('guess-overlay').classList.remove('visible');

  if (currentTeam === 0) {
    document.getElementById('phase-label').textContent = 'ğŸ“ Team A guessed! Team B, ready?';
    showTeamStart(1);
  } else {
    // Both done â†’ reveal
    document.getElementById('btn-guess-a').style.display = 'none';
    showReveal();
  }
}

// â”€â”€ Show Reveal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showReveal() {
  // Update cumulative scores (penalty = 2000km if no guess)
  scores[0] += (guesses[0] ? guesses[0].km : PENALTY_KM);
  scores[1] += (guesses[1] ? guesses[1].km : PENALTY_KM);

  // Winner of this round
  const roundWinner = guesses[0].km <= guesses[1].km ? 0 : 1;

  // Update reveal panel â€” show both locations
  document.getElementById('reveal-location-label').textContent =
    `ğŸ”µ ${teamLocs[0].label}  Â·  ğŸ”´ ${teamLocs[1].label}`;

  for (let i = 0; i < 2; i++) {
    const g = guesses[i];
    const isPenalty = !g || g.penalty;
    document.getElementById('reveal-km-' + i).textContent = isPenalty
      ? `â° +${PENALTY_KM.toLocaleString()} km (time up)`
      : g.km.toLocaleString() + ' km';
    document.getElementById('reveal-total-' + i).textContent = 'Total: ' + scores[i].toLocaleString() + ' km';
    document.getElementById('reveal-badge-' + i).textContent = i === roundWinner ? 'ğŸ… Closer!' : '';
    document.getElementById('reveal-card-' + i).classList.toggle('winner', i === roundWinner);
  }

  const isLastRound = round >= MAX_ROUNDS;
  const nextBtn = document.getElementById('btn-next-reveal');
  nextBtn.textContent = isLastRound ? 'ğŸ See Final Results' : 'Next Round â­';

  document.getElementById('reveal-overlay').classList.add('visible');

  // Init reveal map
  setTimeout(() => {
    if (!revealMap) {
      revealMap = new google.maps.Map(document.getElementById('reveal-map'), {
        zoom: 2,
        center: { lat: 20, lng: 0 },
        disableDefaultUI: true,
        zoomControl: true,
        styles: [{ featureType: 'all', stylers: [{ saturation: -20 }] }]
      });
    }

    // Clear old markers/lines
    if (revealMap._markers) revealMap._markers.forEach(m => m.setMap(null));
    if (revealMap._lines)   revealMap._lines.forEach(l => l.setMap(null));
    revealMap._markers = [];
    revealMap._lines   = [];

    const colors      = ['#3b82f6', '#ef4444'];
    const teamLabels  = ['A', 'B'];
    const starColors  = ['#60a5fa', '#f87171'];  // blue/red star per team
    const bounds      = new google.maps.LatLngBounds();

    for (let i = 0; i < 2; i++) {
      const actualLatLng = { lat: teamLocs[i].lat, lng: teamLocs[i].lng };

      // Actual location (coloured star per team)
      const actualM = new google.maps.Marker({
        position: actualLatLng, map: revealMap,
        label: { text: 'â˜…', color: '#0f0f0f', fontWeight: 'bold', fontSize: '14px' },
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 16,
                fillColor: starColors[i], fillOpacity: 1, strokeColor: '#0f0f0f', strokeWeight: 2 },
        title: teamLocs[i].label, zIndex: 10
      });
      revealMap._markers.push(actualM);
      bounds.extend(actualLatLng);

      if (guesses[i] && !guesses[i].penalty) {
        const pos = { lat: guesses[i].lat, lng: guesses[i].lng };
        const m = new google.maps.Marker({
          position: pos, map: revealMap,
          label: { text: teamLabels[i], color: '#fff', fontWeight: 'bold' },
          icon: { path: google.maps.SymbolPath.CIRCLE, scale: 13,
                  fillColor: colors[i], fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 }
        });
        const line = new google.maps.Polyline({
          path: [pos, actualLatLng], map: revealMap,
          strokeColor: colors[i], strokeOpacity: 0.7, strokeWeight: 2,
          icons: [{ icon: { path: google.maps.SymbolPath.FORWARD_OPEN_ARROW }, offset: '100%' }]
        });
        revealMap._markers.push(m);
        revealMap._lines.push(line);
        bounds.extend(pos);
      }
    }

    revealMap.fitBounds(bounds, { top: 40, right: 40, bottom: 40, left: 40 });
  }, 100);

  // Clean up guess markers
  guessMarkers.forEach(m => { if (m) m.setMap(null); });
  guessMarkers = [null, null];
}

// â”€â”€ Next Round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextRound() {
  document.getElementById('reveal-overlay').classList.remove('visible');

  if (round >= MAX_ROUNDS) {
    showGameOver();
    return;
  }

  round++;
  loadRound();
}

// â”€â”€ Game Over â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showGameOver() {
  document.getElementById('go-km-0').textContent = scores[0].toLocaleString();
  document.getElementById('go-km-1').textContent = scores[1].toLocaleString();

  const winner = scores[0] <= scores[1] ? 0 : 1;
  document.getElementById('go-winner-' + winner).textContent = 'ğŸ† WINNER!';
  document.getElementById('go-winner-' + (1 - winner)).textContent = '';

  document.getElementById('gameover-overlay').classList.add('visible');
}

function restartGame() {
  document.getElementById('gameover-overlay').classList.remove('visible');
  showPackSelector();
}

// â”€â”€ Score card UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateScoreCards() {
  for (let i = 0; i < 2; i++) {
    document.getElementById('score-' + i).textContent = scores[i].toLocaleString();
  }
  // Highlight lower score (winning)
  const winning = scores[0] <= scores[1] ? 0 : 1;
  document.getElementById('score-card-0').classList.toggle('winning', winning === 0 && (scores[0] > 0 || scores[1] > 0));
  document.getElementById('score-card-1').classList.toggle('winning', winning === 1 && (scores[0] > 0 || scores[1] > 0));
}

// â”€â”€ Timer (per-team) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GUESS_SECONDS = 90;
const PENALTY_KM    = 2000;
let timerInterval   = null;
let timerSeconds    = 0;
let timerTeam       = -1;

function startGuessTimer(team) {
  clearInterval(timerInterval);
  timerTeam    = team;
  timerSeconds = GUESS_SECONDS;
  renderTimer();
  timerInterval = setInterval(() => {
    timerSeconds--;
    renderTimer();
    if (timerSeconds <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      applyTimerPenalty(team);
    }
  }, 1000);
}

function pauseTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  timerTeam    = -1;
  timerSeconds = 0;
  const el = document.getElementById('timer-badge');
  el.textContent = 'â± â€”';
  el.className = '';
}

function renderTimer() {
  const el  = document.getElementById('timer-badge');
  const min = Math.floor(timerSeconds / 60);
  const sec = String(timerSeconds % 60).padStart(2, '0');
  const icon = timerTeam === 0 ? 'ğŸ”µ' : 'ğŸ”´';
  el.textContent = `${icon} ${min}:${sec}`;
  el.className = timerSeconds <= 10 ? 'danger' : timerSeconds <= 30 ? 'warning' : '';
}

function applyTimerPenalty(team) {
  document.getElementById('guess-overlay').classList.remove('visible');
  if (pendingMarker) { pendingMarker.setMap(null); pendingMarker = null; }
  pendingLatLng = null;

  guesses[team] = { penalty: true, km: PENALTY_KM };  // no lat/lng â€” skip map pin

  const teamName = team === 0 ? 'Team A' : 'Team B';
  document.getElementById('phase-label').textContent =
    `â° ${teamName} ran out of time! +${PENALTY_KM.toLocaleString()} km penalty`;

  if (team === 0) {
    setTimeout(() => showTeamStart(1), 1500);
  } else {
    setTimeout(() => showReveal(), 1500);
  }
}

function showTeamStart(team) {
  currentTeam = team;
  stopTimer();
  // Hide buttons until team hits START
  document.getElementById('btn-guess-a').style.display  = 'none';
  document.getElementById('btn-skip-loc').style.display = 'none';
  document.getElementById('btn-next').style.display     = 'none';

  const label = document.getElementById('start-team-label');
  label.textContent = team === 0 ? 'TEAM A' : 'TEAM B';
  label.className   = team === 0 ? 'team-a' : 'team-b';
  document.getElementById('start-overlay').classList.add('visible');
}

function beginTurn() {
  document.getElementById('start-overlay').classList.remove('visible');

  // Switch Street View to this team's location
  loadPanorama(teamLocs[currentTeam]);

  // Show correct colour on guess button
  const btn = document.getElementById('btn-guess-a');
  btn.textContent      = currentTeam === 0 ? 'ğŸ”µ Guess your location' : 'ğŸ”´ Guess your location';
  btn.style.background = currentTeam === 0 ? '#3b82f6' : '#ef4444';
  btn.style.color      = '#fff';
  btn.style.display    = 'inline-block';

  document.getElementById('btn-skip-loc').style.display = 'inline-block';

  startGuessTimer(currentTeam);
}

// â”€â”€ Pack Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPackSelector() {
  const overlay = document.getElementById('pack-overlay');
  const grid    = document.getElementById('pack-grid');
  grid.innerHTML = '';

  PACKS.forEach(pack => {
    const btn = document.createElement('button');
    btn.className = 'pack-btn';
    btn.innerHTML = `<span class="pack-name">${pack.label}</span><span class="pack-count">${pack.count} locations</span>`;
    btn.onclick = () => loadPack(pack);
    grid.appendChild(btn);
  });

  overlay.classList.add('visible');
}

async function loadPack(pack) {
  const overlay = document.getElementById('pack-overlay');
  const status  = document.getElementById('pack-status');
  status.textContent = 'Loadingâ€¦';

  try {
    const res  = await fetch(pack.file);
    const data = await res.json();
    // Master file returns array; pack files return { id, label, locations }
    LOCATIONS = Array.isArray(data) ? data : data.locations;
    currentPackLabel = pack.label;
    usedIndices = [];
    overlay.classList.remove('visible');
    status.textContent = '';
    startGame();
  } catch (e) {
    status.textContent = 'âš ï¸ Failed to load pack. Make sure you\'re running from a server.';
  }
}

function startGame() {
  round = 1; scores = [0, 0]; usedIndices = [];
  guessMarkers = [null, null];
  document.getElementById('gameover-overlay').classList.remove('visible');
  loadRound();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMap() {
  document.getElementById('round-total').textContent = MAX_ROUNDS;

  panorama = new google.maps.StreetViewPanorama(
    document.getElementById('street-view'), {
      pov: { heading: 165, pitch: 0, zoom: 1 },
      addressControl: false,
      showRoadLabels: false,
      zoomControl: false,
      fullscreenControl: false,
      motionTracking: false,
      motionTrackingControl: false,
      linksControl: false,
    }
  );

  showPackSelector();
}
</script>

<script>
(function() {
  if (!MAPS_API_KEY || MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') {
    document.getElementById('street-view').innerHTML =
      '<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px;">' +
      '<div style="font-size:3rem">ğŸ”‘</div><div style="font-size:1.3rem;font-weight:700">Add your Google Maps API key to line 1</div></div>';
    return;
  }
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_API_KEY}&callback=initMap&loading=async`;
  s.async = true;
  document.head.appendChild(s);
})();
</script>

</body>
</html>
